name: Publish APT repo from Ethrex release

on:
  repository_dispatch:
    types: [ethrex-release]
  workflow_dispatch:
    inputs:
      tag:
        description: "Version to publish (e.g. 3.0.0 or v3.0.0). Leave empty to use latest."
        required: false
        default: ""

permissions:
  contents: write

# Prevent overlapping pushes to gh-pages
concurrency:
  group: apt-publish-${{ github.repository }}
  cancel-in-progress: false

env:
  SUITE: stable
  COMPONENT: main
  PAGES_BRANCH: gh-pages
  ETHREX_REPO: lambdaclass/ethrex

jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      TAG: ${{ steps.out.outputs.TAG }}
      FETCH_TAG: ${{ steps.out.outputs.FETCH_TAG }}
      VERSION: ${{ steps.out.outputs.VERSION }}
      SKIP: ${{ steps.poolcheck.outputs.SKIP }}
    steps:
      - name: Determine tag (dispatch/manual/latest) and normalize
        id: out
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
          DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          ETHREX_REPO: ${{ env.ETHREX_REPO }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -n "${DISPATCH_TAG}" ]]; then
            TAG="${DISPATCH_TAG}"
          elif [[ -n "${INPUT_TAG}" ]]; then
            TAG="${INPUT_TAG}"
          else
            TAG="$(gh release view --repo "${ETHREX_REPO}" --json tagName -q .tagName)"
          fi

          VERSION="${TAG#v}"
          if [[ "$TAG" =~ ^[0-9] ]]; then
            FETCH_TAG="v${TAG}"
          else
            FETCH_TAG="$TAG"
          fi

          echo "TAG=$TAG" >> "$GITHUB_OUTPUT"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "FETCH_TAG=$FETCH_TAG" >> "$GITHUB_OUTPUT"

      - name: Checkout gh-pages (for skip check)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PAGES_BRANCH }}
          path: ghpages

      - name: Check if version already in pool/
        id: poolcheck
        run: |
          set -euo pipefail
          VER="${{ steps.out.outputs.VERSION }}"
          if ls ghpages/pool/main/e/ethrex/*"${VER}"* >/dev/null 2>&1; then
            echo "SKIP=true" >> "$GITHUB_OUTPUT"
          else
            echo "SKIP=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: resolve-tag
    if: needs.resolve-tag.outputs.SKIP != 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-amd64
            arch: amd64
            pkgname: ethrex
            asset: ethrex-linux_x86_64
          - id: linux-amd64-gpu
            arch: amd64
            pkgname: ethrex-gpu
            asset: ethrex-linux_x86_64-gpu
          - id: linux-arm64
            arch: arm64
            pkgname: ethrex
            asset: ethrex-linux_aarch64
          - id: linux-arm64-gpu
            arch: arm64
            pkgname: ethrex-gpu
            asset: ethrex-linux_aarch64-gpu
    steps:
      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils xz-utils curl

      - name: Download ethrex binary
        run: |
          FETCH_TAG="${{ needs.resolve-tag.outputs.FETCH_TAG }}"
          BASE="https://github.com/${{ env.ETHREX_REPO }}/releases/download/${FETCH_TAG}"
          mkdir -p work
          curl -fL "$BASE/${{ matrix.asset }}" -o work/ethrex
          chmod +x work/ethrex

      - name: Build .deb
        env:
          VERSION: ${{ needs.resolve-tag.outputs.VERSION }}
        run: |
          PKG="${{ matrix.pkgname }}"
          ARCH="${{ matrix.arch }}"
          mkdir -p build/${ARCH}/DEBIAN build/${ARCH}/usr/bin
          install -m 0755 work/ethrex build/${ARCH}/usr/bin/ethrex
          cat > build/${ARCH}/DEBIAN/control <<EOF
          Package: ${PKG}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: LambdaClass <ethrex+infra@lambdaclass.com>
          Description: Ethrex â€” Ethereum execution client (${PKG})
          EOF
          dpkg-deb --build --root-owner-group build/${ARCH}
          mv build/${ARCH}.deb "${PKG}_${VERSION}_${ARCH}.deb"

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.id }}
          path: "*.deb"
          retention-days: 7

  publish:
    needs: [resolve-tag, build]
    if: needs.resolve-tag.outputs.SKIP != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages (working tree)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PAGES_BRANCH }}
          path: pages

      - name: Download all .deb artifacts
        uses: actions/download-artifact@v4
        with:
          path: dl

      - name: Move .debs into pool/
        run: |
          mkdir -p pages/pool/main/e/ethrex
          find dl -type f -name "*.deb" -print -exec mv {} pages/pool/main/e/ethrex/ \;

      - name: Regenerate Packages and Release
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg xz-utils
          pushd pages
          mkdir -p dists/${SUITE}/main/binary-amd64 dists/${SUITE}/main/binary-arm64
          dpkg-scanpackages --arch amd64 pool | tee dists/${SUITE}/main/binary-amd64/Packages | gzip -9 > dists/${SUITE}/main/binary-amd64/Packages.gz
          xz -c9 dists/${SUITE}/main/binary-amd64/Packages > dists/${SUITE}/main/binary-amd64/Packages.xz
          dpkg-scanpackages --arch arm64 pool | tee dists/${SUITE}/main/binary-arm64/Packages | gzip -9 > dists/${SUITE}/main/binary-arm64/Packages.gz
          xz -c9 dists/${SUITE}/main/binary-arm64/Packages > dists/${SUITE}/main/binary-arm64/Packages.xz
          cat > release.conf <<EOF
          APT::FTPArchive::Release::Origin "Ethrex";
          APT::FTPArchive::Release::Label "Ethrex";
          APT::FTPArchive::Release::Suite "${SUITE}";
          APT::FTPArchive::Release::Codename "${SUITE}";
          APT::FTPArchive::Release::Architectures "amd64 arm64";
          APT::FTPArchive::Release::Components "${COMPONENT}";
          APT::FTPArchive::Release::Description "Ethrex APT repository";
          EOF
          apt-ftparchive -c release.conf release dists/${SUITE} > dists/${SUITE}/Release
          popd

      - name: Import signing key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        run: |
          echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --import
          KEYID=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec:/ {print $5; exit}')
          echo "GPG_KEYID=$KEYID" >> $GITHUB_ENV

      - name: Sign Release
        run: |
          pushd pages
          gpg --batch --yes --local-user "$GPG_KEYID" \
              --pinentry-mode loopback --passphrase "${{ secrets.APT_GPG_PASSPHRASE }}" \
              --clearsign -o dists/${SUITE}/InRelease dists/${SUITE}/Release
          gpg --batch --yes --local-user "$GPG_KEYID" \
              --pinentry-mode loopback --passphrase "${{ secrets.APT_GPG_PASSPHRASE }}" \
              -abs -o dists/${SUITE}/Release.gpg dists/${SUITE}/Release
          popd

      - name: Configure SSH commit signing (id_ed25519)
        env:
          SSH_PRIV: ${{ secrets.SSH_BOT_COMMIT_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIV" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keygen -yf ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub
          echo "ethrex+infra@lambdaclass.com $(cat ~/.ssh/id_ed25519.pub)" > ~/.ssh/allowed_signers

          git config --global gpg.format ssh
          git config --global user.signingkey ~/.ssh/id_ed25519
          git config --global gpg.ssh.allowedSignersFile ~/.ssh/allowed_signers
          git config --global commit.gpgsign true
          git config --global user.name "Ethrex Infra Bot"
          git config --global user.email "ethrex+infra@lambdaclass.com"

      - name: Commit & push
        run: |
          cd pages
          git add -A
          git commit -S -m "apt: publish ${{ needs.resolve-tag.outputs.TAG }}" || echo "no changes"
          git pull --rebase origin ${{ env.PAGES_BRANCH }} || true
          git push origin ${{ env.PAGES_BRANCH }}
